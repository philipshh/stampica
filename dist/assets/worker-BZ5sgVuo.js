(function(){"use strict";function P(t){for(let n=0;n<t.length;n+=4){const h=Math.round(.299*t[n]+.587*t[n+1]+.114*t[n+2]);t[n]=t[n+1]=t[n+2]=h}}function X(t,n){let h,e;n&&n.length>=2?(h=n[0],e=n[1]):(h=document.getElementById("color1")&&document.getElementById("color1").value||"#000000",e=document.getElementById("color2")&&document.getElementById("color2").value||"#ffffff");const i=C(h),c=C(e);for(let o=0;o<t.length;o+=4){const r=t[o]/255;t[o]=Math.round(i.r*(1-r)+c.r*r),t[o+1]=Math.round(i.g*(1-r)+c.g*r),t[o+2]=Math.round(i.b*(1-r)+c.b*r)}}function O(t,n){let h,e,i;n&&n.length>=3?(h=n[0],e=n[1],i=n[2]):(h=document.getElementById("color1")&&document.getElementById("color1").value||"#000000",e=document.getElementById("color2")&&document.getElementById("color2").value||"#888888",i=document.getElementById("color3")&&document.getElementById("color3").value||"#ffffff");const c=C(h),o=C(e),r=C(i),g={r:Math.max(0,Math.floor(c.r*.75)),g:Math.max(0,Math.floor(c.g*.75)),b:Math.max(0,Math.floor(c.b*.75))},l=o,s=c.r*.299+c.g*.587+c.b*.114,m=r.r*.299+r.g*.587+r.b*.114,f=s>m?c:r;for(let d=0;d<t.length;d+=4){const F=t[d];F<85?(t[d]=g.r,t[d+1]=g.g,t[d+2]=g.b):F<170?(t[d]=l.r,t[d+1]=l.g,t[d+2]=l.b):(t[d]=f.r,t[d+1]=f.g,t[d+2]=f.b)}}function L(t,n){const h={};let e=0,i={r:128,g:128,b:128};for(let o=0;o<t.length;o+=16){const r=Math.floor(t[o]/32)*32,g=Math.floor(t[o+1]/32)*32,l=Math.floor(t[o+2]/32)*32,s=`${r},${g},${l}`;h[s]=(h[s]||0)+1,h[s]>e&&(e=h[s],i={r,g,b:l})}const c=[{r:Math.max(0,i.r-60),g:Math.max(0,i.g-60),b:Math.max(0,i.b-60)},{r:Math.max(0,i.r-30),g:Math.max(0,i.g-30),b:Math.max(0,i.b-30)},i,{r:Math.min(255,i.r+30),g:Math.min(255,i.g+30),b:Math.min(255,i.b+30)},{r:Math.min(255,i.r+60),g:Math.min(255,i.g+60),b:Math.min(255,i.b+60)}];for(let o=0;o<t.length;o+=4){const r=t[o],g=t[o+1],l=t[o+2],s=.299*r+.587*g+.114*l;let m;s<51?m=0:s<102?m=1:s<153?m=2:s<204?m=3:m=4;const f=c[m];t[o]=f.r,t[o+1]=f.g,t[o+2]=f.b}}function C(t){const n=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);return n?{r:parseInt(n[1],16),g:parseInt(n[2],16),b:parseInt(n[3],16)}:{r:0,g:0,b:0}}function p(t,n){return n==="tritone"?t<85?0:t<170?128:255:n==="quadtone"?t<64?0:t<128?85:t<192?170:255:t>128?255:0}function k(t,n,h,e,i,c,o,r){!r||!t||r.forEach(([g,l,s])=>{const m=e+g,f=i+l;if(m>=0&&m<n&&f>=0&&f<h){const d=(f*n+m)*4+c;t[d]=Math.max(0,Math.min(255,t[d]+o*s))}})}function Q(t,n){let h,e,i,c;n&&n.length>=4?(h=n[0],e=n[1],i=n[2],c=n[3]):(h=document.getElementById("color1")&&document.getElementById("color1").value||"#000000",e=document.getElementById("color2")&&document.getElementById("color2").value||"#555555",i=document.getElementById("color3")&&document.getElementById("color3").value||"#aaaaaa",c=document.getElementById("color4")&&document.getElementById("color4").value||"#ffffff");const o=C(h),r=C(e),g=C(i),l=C(c);for(let s=0;s<t.length;s+=4){const m=t[s];m<64?(t[s]=o.r,t[s+1]=o.g,t[s+2]=o.b):m<128?(t[s]=r.r,t[s+1]=r.g,t[s+2]=r.b):m<192?(t[s]=g.r,t[s+1]=g.g,t[s+2]=g.b):(t[s]=l.r,t[s+1]=l.g,t[s+2]=l.b)}}function W(t,n,h){const e=new Uint8ClampedArray(t.data),i=t.width,c=t.height;n==="monochrome"&&P(e);for(let o=0;o<c;o++)for(let r=0;r<i;r++){const g=(o*i+r)*4;if(n==="color")for(let l=0;l<3;l++){const s=e[g+l],m=p(s,n);e[g+l]=m;const f=s-m;k(e,i,c,r,o,l,f,[[1,0,1/8],[2,0,1/8],[-1,1,1/8],[0,1,1/8],[1,1,1/8],[0,2,1/8]])}else{const l=e[g],s=p(l,n);e[g]=e[g+1]=e[g+2]=s;const m=l-s;k(e,i,c,r,o,0,m,[[1,0,1/8],[2,0,1/8],[-1,1,1/8],[0,1,1/8],[1,1,1/8],[0,2,1/8]])}}return n==="duotone"?X(e,h):n==="tritone"?O(e,h):n==="quadtone"?Q(e,h):n==="cartoon"&&L(e),new ImageData(e,i,c)}function nt(t,n,h){const e=new Uint8ClampedArray(t.data),i=t.width,c=t.height;n==="monochrome"&&P(e);for(let o=0;o<c;o++)for(let r=0;r<i;r++){const g=(o*i+r)*4;if(n==="color")for(let l=0;l<3;l++){const s=e[g+l],m=p(s,n);e[g+l]=m;const f=s-m;k(e,i,c,r,o,l,f,[[1,0,7/16],[-1,1,3/16],[0,1,5/16],[1,1,1/16]])}else{const l=e[g],s=p(l,n);e[g]=e[g+1]=e[g+2]=s;const m=l-s;k(e,i,c,r,o,0,m,[[1,0,7/16],[-1,1,3/16],[0,1,5/16],[1,1,1/16]])}}return n==="duotone"?X(e,h):n==="tritone"?O(e,h):n==="quadtone"?Q(e,h):n==="cartoon"&&L(e),new ImageData(e,i,c)}function et(t,n,h){const e=new Uint8ClampedArray(t.data),i=t.width,c=t.height;n==="monochrome"&&P(e);for(let o=0;o<c;o++)for(let r=0;r<i;r++){const g=(o*i+r)*4;if(n==="color")for(let l=0;l<3;l++){const s=e[g+l],m=p(s,n);e[g+l]=m;const f=s-m;k(e,i,c,r,o,l,f,[[1,0,8/42],[2,0,4/42],[-2,1,2/42],[-1,1,4/42],[0,1,8/42],[1,1,4/42],[2,1,2/42],[-2,2,1/42],[-1,2,2/42],[0,2,4/42],[1,2,2/42],[2,2,1/42]])}else{const l=e[g],s=p(l,n);e[g]=e[g+1]=e[g+2]=s;const m=l-s;k(e,i,c,r,o,0,m,[[1,0,8/42],[2,0,4/42],[-2,1,2/42],[-1,1,4/42],[0,1,8/42],[1,1,4/42],[2,1,2/42],[-2,2,1/42],[-1,2,2/42],[0,2,4/42],[1,2,2/42],[2,2,1/42]])}}return n==="duotone"?X(e,h):n==="tritone"?O(e,h):n==="quadtone"?Q(e,h):n==="cartoon"&&L(e),new ImageData(e,i,c)}const Z=(t,n,h)=>.2126*t+.7152*n+.0722*h;function ot(t,n,h,e=128){const i=new Uint8ClampedArray(t.data),c=t.width,o=t.height;(n==="monochrome"||n==="duotone"||n==="tritone"||n==="cartoon"||n==="quadtone")&&P(i);function r(l,s){return s==="color"?128:e}const g=r(i,n);for(let l=0;l<i.length;l+=4)if(n==="color")for(let s=0;s<3;s++){const m=i[l+s],f=Math.abs(m-g);if(f<4){const d=f/4;i[l+s]=m>g?Math.round(255*(.8+d*.2)):Math.round(255*(.2-d*.2))}else i[l+s]=m>g?255:0}else if(n==="cartoon"){const s=i[l];let m;const f=Math.floor(l/4),d=f%c,F=Math.floor(f/c);let A=0,y=0;for(let w=-1;w<=1;w++)for(let M=-1;M<=1;M++){const B=d+M,a=F+w;if(B>=0&&B<c&&a>=0&&a<o){const u=(a*c+B)*4;A+=Math.abs(i[u]-s),y++}}if(A/=y,A>20)m=s>g?255:0;else{const w=Math.abs(s-g);if(w<8){const M=w/8;m=s>g?Math.round(255*(.7+M*.3)):Math.round(255*(.3-M*.3))}else m=s>g?255:0}i[l]=i[l+1]=i[l+2]=Math.max(0,Math.min(255,m))}else{const s=h.map(w=>C(w)).sort((w,M)=>Z(w.r,w.g,w.b)-Z(M.r,M.g,M.b)),m=i[l],d=(g-128)/128*127.5,F=Math.max(0,Math.min(255,m-d)),A=Math.floor(F/255*s.length),y=s[Math.min(A,s.length-1)];i[l]=y.r,i[l+1]=y.g,i[l+2]=y.b}return n==="cartoon"&&L(i),new ImageData(i,c,o)}async function it(t,n,h,e,i){const c=(n||"atkinson").toLowerCase();let o=e;if(h==="quadtone"){if(!e||e.length<4)for(console.warn("Quadtone requested but palette has fewer than 4 colors. Falling back."),o=e&&e.length>0?e.slice(0):["#000000"];o.length<4;)o.push(o[o.length-1])}else if(h==="tritone"&&(!e||e.length<3))for(console.warn("Tritone requested but palette has fewer than 3 colors. Falling back."),o=e&&e.length>0?e.slice(0):["#000000"];o.length<3;)o.push(o[o.length-1]);switch(c){case"atkinson":return W(t,h,o);case"floyd":case"floyd-steinberg":case"floydsteinberg":return nt(t,h,o);case"stucki":return et(t,h,o);case"threshold":return ot(t,h,o,i);default:return W(t,h,e)}}const ht=t=>{const n=parseInt(t.slice(1,3),16),h=parseInt(t.slice(3,5),16),e=parseInt(t.slice(5,7),16);return[n,h,e]},z=(t,n,h)=>{t/=255,n/=255,h/=255;const e=Math.max(t,n,h),i=Math.min(t,n,h),c=e-i;let o=0;c!==0&&(e===t?o=(n-h)/c%6:e===n?o=(h-t)/c+2:o=(t-n)/c+4,o*=60,o<0&&(o+=360));const r=e===0?0:c/e;return[o,r,e]},st=(t,n)=>{const h=Math.abs(t-n);return Math.min(h,360-h)},rt=(t,n)=>{const h=new Uint8Array(t.width*t.height),e=t.data,i=t.width,c=t.height,[o,r,g]=ht(n.targetHex),[l]=z(o,r,g),s=n.edgeBoost??!0,m=n.edgeThreshold??22;for(let f=0;f<c;f++)for(let d=0;d<i;d++){const F=(f*i+d)*4,A=e[F],y=e[F+1],w=e[F+2],[M,B,a]=z(A,y,w);let D=st(M,l)<=n.hueTolerance&&B>=n.minSaturation&&a>=n.minValue;if(s&&!D){const I=.299*A+.587*y+.114*w;let E=0;if(d<i-1){const x=F+4,b=.299*e[x]+.587*e[x+1]+.114*e[x+2];E=Math.max(E,Math.abs(I-b))}if(f<c-1){const x=((f+1)*i+d)*4,b=.299*e[x]+.587*e[x+1]+.114*e[x+2];E=Math.max(E,Math.abs(I-b))}E>m&&B>n.minSaturation*.6&&(D=!0)}h[f*i+d]=D?255:0}return h},lt=(t,n,h,e=1)=>{const i=new Uint8ClampedArray(t.data.length),c=t.data;for(let o=0;o<c.length;o+=4){const r=o/4;if(n[r]===255)if(e>=1)i[o]=h[0],i[o+1]=h[1],i[o+2]=h[2],i[o+3]=255;else{const g=c[o],l=c[o+1],s=c[o+2];i[o]=Math.round(g+(h[0]-g)*e),i[o+1]=Math.round(l+(h[1]-l)*e),i[o+2]=Math.round(s+(h[2]-s)*e),i[o+3]=255}else i[o]=c[o],i[o+1]=c[o+1],i[o+2]=c[o+2],i[o+3]=255}return new ImageData(i,t.width,t.height)},tt=[{name:"Base Reference",shadow:"#0B0B0F",midShadow:"#4B3FA6",midHighlight:"#D19A9A",highlight:"#FFFFFF"},{name:"Cold Neon Night",shadow:"#0A0F1F",midShadow:"#1F3C88",midHighlight:"#6EE7FF",highlight:"#F5FBFF"},{name:"Retro Cyberpunk",shadow:"#120A1A",midShadow:"#5B2E8A",midHighlight:"#FF5DA2",highlight:"#FFF2F7"},{name:"Warm Analog Film",shadow:"#1C120B",midShadow:"#6B3E2E",midHighlight:"#D9A066",highlight:"#FFF3E6"},{name:"Forest Dusk",shadow:"#0D1A14",midShadow:"#1F4D3A",midHighlight:"#8FC9A3",highlight:"#F2FFF8"},{name:"Desert Sunset",shadow:"#2A1208",midShadow:"#8A3E1F",midHighlight:"#F2A65A",highlight:"#FFF1E3"},{name:"Ice & Steel",shadow:"#0B141A",midShadow:"#2F5F7A",midHighlight:"#A7D8F0",highlight:"#F7FCFF"},{name:"Noir Purple",shadow:"#0E0B14",midShadow:"#3A2F5F",midHighlight:"#9E8AD9",highlight:"#F5F2FF"},{name:"Toxic Lime",shadow:"#0B1205",midShadow:"#2E5F1A",midHighlight:"#9AFF3C",highlight:"#F6FFE8"},{name:"Blood & Bone",shadow:"#120505",midShadow:"#5F1A1A",midHighlight:"#C94A4A",highlight:"#FFF0F0"},{name:"Blueprint Tech",shadow:"#07121F",midShadow:"#0E3A66",midHighlight:"#5FB3FF",highlight:"#F4FAFF"},{name:"Dark Knight Neon",shadow:"#0B0E2A",midShadow:"#1F2B8F",midHighlight:"#F07C73",highlight:"#F6E6CF"},{name:"Neon Noir",shadow:"#0A0A14",midShadow:"#2B2FFF",midHighlight:"#FF5DA2",highlight:"#FFE6F0"},{name:"Electric Sunset",shadow:"#120A1F",midShadow:"#3A2A8F",midHighlight:"#FF8A5B",highlight:"#FFE3C4"},{name:"Blade Runner Fog",shadow:"#0E1020",midShadow:"#39406B",midHighlight:"#C97C7C",highlight:"#E6DCD2"},{name:"Midnight Coral",shadow:"#0A0D1A",midShadow:"#2430A8",midHighlight:"#FF6F61",highlight:"#FFF1E6"},{name:"Ultraviolet Cream",shadow:"#0C0C1E",midShadow:"#4B3FD6",midHighlight:"#E58BAA",highlight:"#F4EBDD"},{name:"Neo Tokyo",shadow:"#060611",midShadow:"#1C2CFF",midHighlight:"#FF4D4D",highlight:"#FFE9D6"},{name:"Cold Flame",shadow:"#070B1A",midShadow:"#2233AA",midHighlight:"#FF7A3D",highlight:"#FFF0D8"},{name:"Synthwave Dusk",shadow:"#140A1F",midShadow:"#5B2DAA",midHighlight:"#FF77A8",highlight:"#FFEAF3"},{name:"Graphite Rose",shadow:"#0F1116",midShadow:"#2E3448",midHighlight:"#C07A8A",highlight:"#EDE1E5"}];tt.map(t=>({name:t.name,shadow:t.shadow,mid:t.midShadow,highlight:t.highlight})),tt.map(t=>({name:t.name,shadow:t.shadow,highlight:t.highlight}));const K=(t,n,h)=>.2126*t+.7152*n+.0722*h,T=t=>Math.pow(t/255,2.2),v=t=>Math.pow(Math.max(0,Math.min(1,t)),1/2.2)*255,at=(t,n,h,e,i)=>{let c=1/0,o=e[0];for(const r of e){let g=0;i==="linear"?g=Math.pow(t-r[0],2)+Math.pow(n-r[1],2)+Math.pow(h-r[2],2):i==="smooth"?g=Math.pow(t-r[0],2)*.2126+Math.pow(n-r[1],2)*.7152+Math.pow(h-r[2],2)*.0722:g=Math.pow(t-r[0],2)*.299+Math.pow(n-r[1],2)*.587+Math.pow(h-r[2],2)*.114,g<c&&(c=g,o=r)}return o},ct=(t,n,h,e)=>{const i=t.data,c=new Uint8ClampedArray(i.length),o=(n||0)/100,r=((typeof h=="number"?h:0)+100)/100,g=r*r,l=e&&e>0?e:1;for(let s=0;s<i.length;s+=4){let m=i[s]/255,f=i[s+1]/255,d=i[s+2]/255;m=m+o,f=f+o,d=d+o,m=(m-.5)*g+.5,f=(f-.5)*g+.5,d=(d-.5)*g+.5,l!==1&&(m=Math.pow(Math.max(0,m),1/l),f=Math.pow(Math.max(0,f),1/l),d=Math.pow(Math.max(0,d),1/l)),c[s]=Math.min(255,Math.max(0,Math.round(m*255))),c[s+1]=Math.min(255,Math.max(0,Math.round(f*255))),c[s+2]=Math.min(255,Math.max(0,Math.round(d*255))),c[s+3]=i[s+3]!==void 0?i[s+3]:255}return new ImageData(c,t.width,t.height)},gt=(t,n)=>{if(n<=1)return t;const h=t.width,e=t.height,i=Math.floor(h/n),c=Math.floor(e/n),o=t.data,r=new Uint8ClampedArray(i*c*4);for(let g=0;g<c;g++)for(let l=0;l<i;l++){let s=0,m=0,f=0,d=0;const F=g*n,A=l*n;for(let w=0;w<n&&F+w<e;w++)for(let M=0;M<n&&A+M<h;M++){const B=((F+w)*h+(A+M))*4;s+=o[B],m+=o[B+1],f+=o[B+2],d++}const y=(g*i+l)*4;r[y]=Math.round(s/d),r[y+1]=Math.round(m/d),r[y+2]=Math.round(f/d),r[y+3]=255}return new ImageData(r,i,c)};self.onmessage=async t=>{var M,B;const{imageData:n,options:h}=t.data,{algorithm:e,threshold:i,palette:c,pointSize:o,colorPipeline:r}=h,g=ct(n,h.brightness,h.contrast,h.gamma);if(h.invert)for(let a=0;a<g.data.length;a+=4)g.data[a]=255-g.data[a],g.data[a+1]=255-g.data[a+1],g.data[a+2]=255-g.data[a+2];const l=gt(g,o),s=l.width,m=l.height,f=l.data;if(h.engine==="dg")try{const a=c.map(x=>{const b=U=>{const S=Math.max(0,Math.min(255,Math.round(U))).toString(16);return S.length===1?"0"+S:S};return`#${b(x[0])}${b(x[1])}${b(x[2])}`});let u=null;(M=h.accent)!=null&&M.enabled&&(u=rt(l,{enabled:!0,targetHex:h.accent.detectHex,hueTolerance:h.accent.hueTolerance,minSaturation:h.accent.minSaturation,minValue:h.accent.minValue,edgeBoost:h.accent.edgeBoost,edgeThreshold:h.accent.edgeThreshold}));const D=await it(l,e,h.colorMode==="rgb"?"color":h.colorMode,a,h.threshold);let I=D;u&&((B=h.accent)!=null&&B.enabled)&&(I=lt(D,u,[h.accent.color.r,h.accent.color.g,h.accent.color.b],h.accent.strength));const E=new Uint8ClampedArray(I.data);for(let x=3;x<E.length;x+=4)E[x]=255;Y(E,I.width,I.height,n.width,n.height,o,t.data.jobId);return}catch(a){self.postMessage({error:`DG engine failed: ${a&&a.message?a.message:String(a)}`,fallback:"classic",jobId:t.data.jobId});return}const d=new Float32Array(f.length);for(let a=0;a<f.length;a+=4)r==="linear"?(d[a]=T(f[a]),d[a+1]=T(f[a+1]),d[a+2]=T(f[a+2])):(d[a]=f[a],d[a+1]=f[a+1],d[a+2]=f[a+2]),d[a+3]=f[a+3];const F=c.map(a=>r==="linear"?[T(a[0]),T(a[1]),T(a[2])]:[a[0],a[1],a[2]]);if(e==="none"){const a=new Uint8ClampedArray(f.length);for(let u=0;u<f.length;u+=4)a[u]=r==="linear"?v(d[u]):d[u],a[u+1]=r==="linear"?v(d[u+1]):d[u+1],a[u+2]=r==="linear"?v(d[u+2]):d[u+2],a[u+3]=255;for(let u=3;u<a.length;u+=4)a[u]=255;Y(a,s,m,n.width,n.height,o,t.data.jobId);return}const A=(a,u)=>(u*s+a)*4;let y=[...F];e==="threshold"&&y.sort((a,u)=>K(a[0],a[1],a[2])-K(u[0],u[1],u[2]));for(let a=0;a<m;a++){const u=a%2!==0,D=u?s-1:0,I=u?-1:s,E=u?-1:1;for(let x=D;x!==I;x+=E){const b=A(x,a),U=d[b],S=d[b+1],_=d[b+2];let H;if(e==="threshold"){const J=K(U,S,_),G=r==="linear"?1:255,$=G/2,q=(i-128)/128*$,R=Math.max(0,Math.min(G,J-q)),N=Math.floor(R/G*y.length);H=y[Math.min(N,y.length-1)]}else H=at(U,S,_,F,r);d[b]=H[0],d[b+1]=H[1],d[b+2]=H[2];const dt=U-H[0],mt=S-H[1],ft=_-H[2],V=(J,G,$)=>{const q=x+J,R=a+G;if(q>=0&&q<s&&R>=0&&R<m){const N=A(q,R);d[N]+=dt*$,d[N+1]+=mt*$,d[N+2]+=ft*$}},j=E;e==="atkinson"&&(V(j*1,0,1/8),V(j*2,0,1/8),V(j*-1,1,1/8),V(0,1,1/8),V(j*1,1,1/8),V(0,2,1/8))}}const w=new Uint8ClampedArray(f.length);for(let a=0;a<f.length;a+=4)w[a]=r==="linear"?v(d[a]):d[a],w[a+1]=r==="linear"?v(d[a+1]):d[a+1],w[a+2]=r==="linear"?v(d[a+2]):d[a+2],w[a+3]=255;for(let a=3;a<w.length;a+=4)w[a]=255;Y(w,s,m,n.width,n.height,o,t.data.jobId)};function Y(t,n,h,e,i,c,o){if(c>1){const r=new Uint8ClampedArray(e*i*4);for(let g=0;g<i;g++)for(let l=0;l<e;l++){const s=Math.floor(l/c),m=Math.floor(g/c),f=Math.min(s,n-1),F=(Math.min(m,h-1)*n+f)*4,A=(g*e+l)*4;r[A]=t[F],r[A+1]=t[F+1],r[A+2]=t[F+2],r[A+3]=255}self.postMessage({imageData:new ImageData(r,e,i),jobId:o})}else self.postMessage({imageData:new ImageData(t,n,h),jobId:o})}})();
